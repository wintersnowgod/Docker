#!/usr/bin/env bash

cd "$(dirname "$(readlink -f "$0")")" || exit 1

declare -A postStartScripts
postStartScripts=(
  ["diun.yml"]="webhooknotif.py --port 9999"
  # Add more mappings as needed:
  # ["other.yml"]="echo 'Container started'"
)

startSkipped=()
startFailed=()
startSuccess=()
startPostStartScriptSuccess=()
startPostStartScriptFailed=()

# List of files to ignore (just the filename, not the path)
ignoreFiles=("hwaccel.ml.yml" "hwaccel.transcoding.yml")

isIgnored() {
  local file="$1"
  for ignore in "${ignoreFiles[@]}"; do
    if [[ "$(basename "$file")" == "$ignore" ]]; then
      return 0
    fi
  done
  return 1
}

isRunning() {
  local composeFile="$1"
  local containers
  containers=$(docker compose -f "$composeFile" ps -q)
  if [ -z "$containers" ]; then
    return 1
  fi

  local failed=()
  local running=()

  for container in $containers; do
    local state
    state=$(docker inspect -f '{{.State.Running}}' "$container")
    if [[ "$state" == "true" ]]; then
      running+=("$container")
    else
      failed+=("$container")
    fi
  done

  [[ ${#running[@]} -gt 0 ]] && return 0 || return 1
}

startScript() {
  local composeFile="$1"
  local composeFileBasename
  composeFileBasename=$(basename "$composeFile")
  if [[ -n "${postStartScripts[$composeFileBasename]}" ]]; then
    local postStartScript="${postStartScripts[$composeFileBasename]}"
    local postStartScriptBase="${postStartScript%% *}"
    local postStartScriptArgs="${postStartScript#* }"
    if [[ "$postStartScriptArgs" == "$postStartScript" ]]; then
      postStartScriptArgs=""
    fi

    local postStartScriptName
    postStartScriptName=$(find . -maxdepth 2 -type f -name "$postStartScriptBase" -print -quit)

    if [[ -n "$postStartScriptName" ]]; then
      echo "   Found script at: $postStartScriptName"
      chmod +x "$postStartScriptName"
      echo "   Running: $postStartScriptName $postStartScriptArgs"
      if
        nohup "$postStartScriptName" $postStartScriptArgs >/dev/null 2>&1 &
        disown
      then
        startPostStartScriptSuccess+=("$postStartScriptName $postStartScriptArgs")
      else
        echo "  Failed to start $postStartScriptBase $postStartScriptArgs"
        startPostStartScriptFailed+=("$postStartScriptBase $postStartScriptArgs")
      fi
    else
      echo "   Warning: Could not find $postStartScriptBase within maxdepth 2. Skipping."
      startPostStartScriptFailed+=("$postStartScriptBase $postStartScriptArgs")
    fi
  fi
}

startContainer() {
  local composeFile="$1"

  if isIgnored "$composeFile"; then
    echo "Skipping ignored file: $composeFile"
    return
  fi

  local projectName
  projectName=$(basename "${composeFile%.*}" | tr '.' '_')

  if isRunning "$composeFile"; then
    echo "$projectName is already Running!!!"
    startSkipped+=("$composeFile")
    return
  fi

  echo "=> Starting $composeFile ..."

  if docker compose -f "$composeFile" -p "$projectName" up -d; then
    startScript "$composeFile"
    startSuccess+=("$composeFile")
  else
    startFailed+=("$composeFile")
  fi
}

if [ -n "$1" ]; then
  composeFile=$(find . -maxdepth 2 -type f \( -name "$1.yml" -o -name "$1.yaml" \) | head -n 1)
  if [ -f "$composeFile" ]; then
    startContainer "$composeFile"
  else
    echo "File $1.yml/yaml not found."
    exit 1
  fi
else
  while read -r composeFile; do
    startContainer "$composeFile"
    echo
  done < <(find . -maxdepth 2 -type f \( -name "*.yml" -o -name "*.yaml" \))
fi

if [ -n "$1" ]; then
  if ((${#startSkipped[@]})); then
    echo
    printf ' \033[1mℹ\033[0m Skipped (already running) %s\n' "${startSkipped[@]}"
  fi

  if ((${#startSuccess[@]})); then
    echo
    printf ' ✔ Successfully started %s\n' "${startSuccess[@]}"
  fi

  if ((${#startPostStartScriptSuccess[@]})); then
    echo
    printf ' ✔ Successfully started script %s\n' "${startPostStartScriptSuccess[@]}"
  fi

  if ((${#startFailed[@]})) || ((${#startPostStartScriptFailed[@]})); then
    if ((${#startFailed[@]})); then
      echo
      printf ' ✘ Failed to start %s\n' "${startFailed[@]}"
    fi
    if ((${#startPostStartScriptFailed[@]})); then
      echo
      printf ' ✘ Failed to start script %s\n' "${startPostStartScriptFailed[@]}"
    fi
    exit 2
  else
    exit 0
  fi
else
  echo
  echo "===== SUMMARY ====="

  if ((${#ignoreFiles[@]})); then
    echo
    echo "Ignored Files:"
    printf ' \033[1mℹ\033[0m %s\n' "${ignoreFiles[@]}"
  fi

  if ((${#startSkipped[@]})); then
    echo
    echo "Skipped (already running):"
    printf ' \033[1mℹ\033[0m %s\n' "${startSkipped[@]}"
  fi

  if ((${#startSuccess[@]})); then
    echo
    echo "Successful starts:"
    printf ' ✔ %s\n' "${startSuccess[@]}"
  fi

  if ((${#startPostStartScriptSuccess[@]})); then
    echo
    echo "Successful script starts:"
    printf ' ✔ %s\n' "${startPostStartScriptSuccess[@]}"
  fi

  if ((${#startFailed[@]})) || ((${#startPostStartScriptFailed[@]})); then
    if ((${#startFailed[@]})); then
      echo
      echo "Failed starts:"
      printf ' ✘ %s\n' "${startFailed[@]}"
    fi
    if ((${#startPostStartScriptFailed[@]})); then
      echo
      echo "Failed script starts:"
      printf ' ✘ %s\n' "${startPostStartScriptFailed[@]}"
    fi
    exit 2
  else
    exit 0
  fi
fi
