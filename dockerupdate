#!/usr/bin/env bash

cd "$(dirname "$(readlink -f "$0")")" || exit 1

declare -A postStartScripts
postStartScripts=(
  ["diun.yml"]="webhooknotif.py --port 9999"
  # Add more mappings as needed:
  # ["other.yml"]="echo 'Container started'"
)

updateFailed=()
updateSuccess=()
stopPostStartScriptSuccess=()
stopPostStartScriptFailed=()
startPostStartScriptSuccess=()
startPostStartScriptFailed=()

# List of files to ignore (just the filename, not the path)
ignoreFiles=("hwaccel.ml.yml" "hwaccel.transcoding.yml")

isIgnored() {
  local file="$1"
  for ignore in "${ignoreFiles[@]}"; do
    if [[ "$(basename "$file")" == "$ignore" ]]; then
      return 0
    fi
  done
  return 1
}

isRunning() {
  local composeFile="$1"
  local containers
  containers=$(docker compose -f "$composeFile" ps -q)
  if [ -z "$containers" ]; then
    return 1
  fi

  local failed=()
  local running=()

  for container in $containers; do
    local state
    state=$(docker inspect -f '{{.State.Running}}' "$container")
    if [[ "$state" == "true" ]]; then
      running+=("$container")
    else
      failed+=("$container")
    fi
  done

  [[ ${#running[@]} -gt 0 ]] && return 0 || return 1
}

stopScript() {
  local composeFile="$1"
  local composeFileBasename
  composeFileBasename=$(basename "$composeFile")
  if [[ -n "${postStartScripts[$composeFileBasename]}" ]]; then
    local postStartScript="${postStartScripts[$composeFileBasename]}"
    local postStartScriptBase="${postStartScript%% *}"
    local postStartScriptArgs="${postStartScript#* }"
    if [[ "$postStartScriptArgs" == "$postStartScript" ]]; then
      postStartScriptArgs=""
    fi

    local postStartScriptName
    postStartScriptName=$(find . -maxdepth 2 -type f -name "$postStartScriptBase" -print -quit)

    if [[ -n "$postStartScriptName" ]]; then
      echo "   Found script at: $postStartScriptName"
      chmod +x "$postStartScriptName"
      echo "   Stopping: $postStartScriptName $postStartScriptArgs"
      if kill -9 $(pgrep -f "$postStartScriptName $postStartScriptArgs" 2>/dev/null) 2>/dev/null; then
        stopPostStartScriptSuccess+=("$postStartScriptName $postStartScriptArgs")
      else
        echo "  Failed to stop $postStartScriptBase $postStartScriptArgs"
        stopPostStartScriptFailed+=("$postStartScriptBase $postStartScriptArgs")
      fi
    else
      echo "   Warning: Could not find $postStartScriptBase within maxdepth 2. Skipping."
      stopPostStartScriptFailed+=("$postStartScriptBase $postStartScriptArgs")
    fi
  fi
}

startScript() {
  local composeFile="$1"
  local composeFileBasename=$(basename "$composeFile")
  if [[ -n "${postStartScripts[$composeFileBasename]}" ]]; then
    local postStartScript="${postStartScripts[$composeFileBasename]}"
    local postStartScriptBase="${postStartScript%% *}"
    local postStartScriptArgs="${postStartScript#* }"
    if [[ "$postStartScriptArgs" == "$postStartScript" ]]; then
      postStartScriptArgs=""
    fi

    local postStartScriptName
    postStartScriptName=$(find . -maxdepth 2 -type f -name "$postStartScriptBase" -print -quit)

    if [[ -n "$postStartScriptName" ]]; then
      echo "   Found script at: $postStartScriptName"
      chmod +x "$postStartScriptName"
      echo "   Running: $postStartScriptName $postStartScriptArgs"
      if
        nohup "$postStartScriptName" $postStartScriptArgs >/dev/null 2>&1 &
        disown
      then
        startPostStartScriptSuccess+=("$postStartScriptName $postStartScriptArgs")
      else
        echo "  Failed to start $postStartScriptBase $postStartScriptArgs"
        startPostStartScriptFailed+=("$postStartScriptBase $postStartScriptArgs")
      fi
    else
      echo "   Warning: Could not find $postStartScriptBase within maxdepth 2. Skipping."
      startPostStartScriptFailed+=("$postStartScriptBase $postStartScriptArgs")
    fi
  fi
}

updateImage() {
  local composeFile="$1"

  if isIgnored "$composeFile"; then
    echo "Skipping ignored file: $composeFile"
    return
  fi

  local projectName
  projectName=$(basename "${composeFile%.*}" | tr '.' '_')

  echo "=> Updating $composeFile ..."

  if isRunning "$composeFile"; then
    stopScript "$composeFile"
    if docker compose -f "$composeFile" pull &&
      docker compose -f "$composeFile" -p "$projectName" down &&
      docker compose -f "$composeFile" -p "$projectName" up -d; then
      startScript "$composeFile"
      updateSuccess+=("$composeFile")
    else
      updateFailed+=("$composeFile")
    fi
  else
    if docker compose -f "$composeFile" pull &&
      docker compose -f "$composeFile" -p "$projectName" up -d; then
      startScript "$composeFile"
      updateSuccess+=("$composeFile")
    else
      updateFailed+=("$composeFile")
    fi
  fi
}

if [ -n "$1" ]; then
  composeFile=$(find . -maxdepth 2 -type f \( -name "$1.yml" -o -name "$1.yaml" \) | head -n 1)
  if [ -f "$composeFile" ]; then
    updateImage "$composeFile"
  else
    echo "File $1.yml/yaml not found."
    exit 1
  fi
else
  while read -r composeFile; do
    updateImage "$composeFile"
    echo
  done < <(find . -maxdepth 2 -type f \( -name "*.yml" -o -name "*.yaml" \))
fi

if [ -n "$1" ]; then
  if ((${#updateSuccess[@]})); then
    echo
    printf ' ✔ Successfully updated %s\n' "${updateSuccess[@]}"
  fi

  if ((${#stopPostStartScriptSuccess[@]})); then
    echo
    printf ' ✔ Successfully stopped script %s\n' "${stopPostStartScriptSuccess[@]}"
  fi

  if ((${#startPostStartScriptSuccess[@]})); then
    echo
    printf ' ✔ Successfully started script %s\n' "${startPostStartScriptSuccess[@]}"
  fi

  if ((${#updateFailed[@]})) || ((${#stopPostStartScriptFailed[@]})) || ((${#startPostStartScriptFailed[@]})); then
    if ((${#updateFailed[@]})); then
      echo
      printf ' ✘ Failed to update %s\n' "${updateFailed[@]}"
    fi
    if ((${#stopPostStartScriptFailed[@]})); then
      echo
      printf ' ✘ Failed to stop script %s\n' "${stopPostStartScriptFailed[@]}"
    fi
    if ((${#startPostStartScriptFailed[@]})); then
      echo
      printf ' ✘ Failed to start script %s\n' "${startPostStartScriptFailed[@]}"
    fi
    exit 2
  else
    exit 0
  fi
else
  echo
  echo "===== SUMMARY ====="

  if ((${#ignoreFiles[@]})); then
    echo
    echo "Ignored Files:"
    printf ' \033[1mℹ\033[0m %s\n' "${ignoreFiles[@]}"
  fi

  if ((${#updateSuccess[@]})); then
    echo
    echo "Successful updates:"
    printf ' ✔ %s\n' "${updateSuccess[@]}"
  fi

  if ((${#stopPostStartScriptSuccess[@]})); then
    echo
    echo "Successful script stops:"
    printf ' ✔ %s\n' "${stopPostStartScriptSuccess[@]}"
  fi

  if ((${#startPostStartScriptSuccess[@]})); then
    echo
    echo "Successful script starts:"
    printf ' ✔ %s\n' "${startPostStartScriptSuccess[@]}"
  fi

  if ((${#updateFailed[@]})) || ((${#stopPostStartScriptFailed[@]})) || ((${#startPostStartScriptFailed[@]})); then
    if ((${#updateFailed[@]})); then
      echo
      echo "Failed updates:"
      printf ' ✘ %s\n' "${updateFailed[@]}"
    fi
    if ((${#stopPostStartScriptFailed[@]})); then
      echo
      echo "Failed script stops:"
      printf ' ✘ %s\n' "${stopPostStartScriptFailed[@]}"
    fi
    if ((${#startPostStartScriptFailed[@]})); then
      echo
      echo "Failed script starts:"
      printf ' ✘ %s\n' "${startPostStartScriptFailed[@]}"
    fi
    exit 2
  else
    exit 0
  fi
fi
